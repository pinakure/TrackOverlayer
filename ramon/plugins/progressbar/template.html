<!DOCTYPE html>
<html type="plugin" version="0.3" author="smiker@m4gtracker.com">
    <head>
        <link rel="stylesheet" type="text/css" href="./{% name %}.css"/>
        <style>
            {% fonts %}

            * {
                padding     : 0px 0px 0px 0px;
                margin      : 0px 0px 0px 0px;
            }

            span, img, div {
                /*zoom        : 1.4;*/
                display                     : inline-block;
                line-height                 : var( --percent-line-height );
                font-family                 : var( --percent-font );
                font-size                   : var( --percent-font-size );
                font-weight                 : var( --percent-font-bold );
                font-style                  : var( --percent-font-italic );
                color                       : var( --percent-color );
                position                    : absolute;   
                top                         : 0px;
                left                        : 0px;
                text-shadow                 : var(--percent-shadow-pos-x) var(--percent-shadow-pos-y) var(--percent-shadow-blur) var(--percent-shadow-color);
                -webkit-text-stroke         : var(--percent-border-width);
                -webkit-text-stroke-color   : var(--percent-border-color);
                overflow                    : hidden; 
                text-overflow               : ellipsis;
                text-align                  : center;
                height                      : 100%;
                width                       : 100%;
                vertical-align              : middle;
            }
            
            span {
                filter                      : opacity(1.0);
            }

            #theonlybar {
                transition-duration         : 3s;
                transition-timing-function  : ease-in-out;
            }

            .glow {
                animation-name              : glow;
                animation-timing-function   : ease-out;
                animation-fill-mode         : forwards;
                animation-iteration-count   : 1;
                animation-duration          : 3s;
            }

            @keyframes glow {
                  0%{ filter: grayscale(100) brightness(400%); }
                100%{ filter: grayscale(  0) brightness(100%); }
            }
            
            .fadeout {
                animation-name              : fadeout;
                animation-timing-function   : ease-out;
                animation-fill-mode         : forwards;
                animation-iteration-count   : 1;
                animation-duration          : 4s;
            }

            @keyframes fadeout {
                  0%{ filter:opacity(1.0) brightness(400%); }
                 25%{ filter:opacity(0.0) brightness(400%); }
                 75%{ filter:opacity(0.0) brightness(400%); }
                100%{ filter:opacity(1.0) brightness(100%); }
            }
            html { height: 100%; }
            body { height: 100%; }
            .progressbar {
                height: 100%;
            }
            #theonlybar {
                filter: opacity({% bar-opacity %});
                width:50%;
                height: 100%;
                background-image: linear-gradient(180deg, var(--up-color) ,var(--mid-color) ,var(--low-color) );
            }
        </style>
    </head>
    <body>
        <div class="{% name %}" id="{% name %}">
            <img src="{% backdrop-file %}"/>
            <div class="completion" id="theonlybar"></div>
            <span id="pc" class="percent">/*JS*/</span>
            <img src="{% overlay-file %}"/>
        </div> 
        <script>
            {% plugin %}
            
            var {% Name %} = {

                dom             : {
                    {% name %}      : document.getElementById('{% name %}'),
                    bar             : document.getElementById('theonlybar'),
                },

                {% load-config %}

                update : function(){ 
                    document.getElementById('pc').className="percent";
                    setProgress(localStorage.getItem('cheevo-progress'))                    
                },

                start : function(){
                    {% Name %}.loadSettings();
                    {% Name %}.settings.update = { rate : 5 };
                    {% Name %}.update();
                },
            };

            
            function setProgress(progress){
                var last_progress = localStorage.getItem('cheevo-last-progress');
                localStorage.setItem('cheevo-last-progress', progress);
                {% Name %}.dom.bar.style.width = last_progress;
                if(progress != last_progress){
                    {% Name %}.dom.bar.style.transitionProperty = '';
                    {% Name %}.dom.bar.style.width = last_progress;
                    document.getElementById('pc').innerHTML=last_progress;
                    
                    setTimeout(function(){
                        if( parseInt(progress) > parseInt(last_progress)) {
                            audio = new Audio('./{% sound.file %}');
                            audio.play();
                            if( {% Name %}.settings.glow )
                                {% Name %}.dom.bar.className = 'completion glow';
                        }                
                        document.getElementById('pc').className="percent fadeout";
                        {% Name %}.dom.bar.style.transitionProperty = 'width';
                        {% Name %}.dom.bar.style.width = progress;
                        setTimeout(function(){
                            document.getElementById('pc').innerHTML=progress;
                            
                            {% Name %}.dom.bar.className = 'completion';
                            setTimeout({% Name %}.update, 3000)
                        }, 3000);
                    }, 1000);                     
                } else setTimeout({% Name %}.update, 3000)
                /* Hide widget if no cheevo is selected or program is not yet ready */
                {% require-cheevo %}
            }
            
            {% update-css %}
            {% Name %}.start();

            setProgress('/*JS*/');    
            setProgress(50);    
        </script>
    </body>
</html>