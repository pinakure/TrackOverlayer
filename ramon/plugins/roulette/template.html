<!DOCTYPE html>
    <html type="plugin" version="0.?" author="smiker@m4gtracker.com">
    <head>
        <link rel="stylesheet" type="text/css" href="./css/{% name %}.css">
        <title>{% Name %}</title>
        <style>
            {% fonts %}
            {% fullsized %}
            * {
                padding: 0px;
                margin:0px;
                box-sizing: border-box;
                user-select: none;
            }
            body {
                perspective: 1800px;
                overflow: hidden;
                perspective-origin: 50% 50%;
            }
            
            #{% name %}{
                transform: translateZ(-500px) translateY( calc( var(--size-x) / 2 ) ) rotateX(56deg);
            }

            #output, #output-shadow {
                box-shadow: 5px 5px 8px #000c;
                border  : 1px solid #000;
                border-radius: 50%;
                overflow: hidden;
                z-index : 1000;
                position: absolute;
                display: inline-block;
                width   : var(--size-x);
                height  : var(--size-x);
                top     : calc( 50% - calc( var(--size-x) / 2 ) );
                left    : calc( 50% - calc( var(--size-x) / 2 ) );
            }

            #output {
                box-shadow: 0px 0px 8px #000c;
            }
            .slice {
                display             : inline-block;
                /*background-image    : linear-gradient(-270deg, #ffffff80 30%, #00000080, #ffffff80 70%);*/
                background-image    : linear-gradient(-270deg, #ffffff80, #00000080);
                position            : absolute;
                top                 : 50%;
                left                : 50%;
                width               : 60%;
                height              : 60%;
                clip-path           : polygon( 0%   0%, 100%   0%,100% 100%,0%   0%);
            }
            .slice:nth-child(1){    transform-origin: top left; transform: rotateZ(  0deg );  background-color: #ff0000; }
            .slice:nth-child(2){    transform-origin: top left; transform: rotateZ( 45deg );  background-color: #ffff00; }
            .slice:nth-child(3){    transform-origin: top left; transform: rotateZ( 90deg );  background-color: #802020; }
            .slice:nth-child(4){    transform-origin: top left; transform: rotateZ(135deg );  background-color: #ffc020; }
            .slice:nth-child(5){    transform-origin: top left; transform: rotateZ(180deg );  background-color: #00ff00; }
            .slice:nth-child(6){    transform-origin: top left; transform: rotateZ(225deg );  background-color: #00ffff; }
            .slice:nth-child(7){    transform-origin: top left; transform: rotateZ(270deg );  background-color: #0000ff; }
            .slice:nth-child(8){    transform-origin: top left; transform: rotateZ(315deg );  background-color: #a020ff; }
            
            .slice span { 
                transform-origin        : top left;
                display                 : inline-block; 
                position                : absolute; 
                top                     : 0.5%; 
                left                    : 8%; 
                text-align              : center;
                transform               : rotateZ( 20deg ); 
                font-size               : 17px; 
                color                   : #fff8;
                text-shadow             : 0px 0px 4px #fffd;
                font-family             : 'noir-caps'; 
                text-overflow           : hidden;
                height                  : 28px;/*line-height*/
                width                   : 100%;
                overflow                : hidden;
            }

            .rolling {
                animation-name: rolling;
                animation-duration: 1s;
                animation-timing-function: linear;
                animation-delay: 0s;
                animation-iteration-count: infinite; 
                animation-direction: normal;
                animation-play-state: running;
                animation-fill-mode: forwards;
            }
            
            .starting {
                animation-name: rolling;
                animation-duration: 2s;
                animation-timing-function: ease-in;
                animation-delay: 0s;
                animation-iteration-count: infinite; 
                animation-direction: normal;
                animation-play-state: running;
                animation-fill-mode: forwards;
            }
            
            .stopping {
                animation-name: stopping;
                animation-duration: 4s;
                animation-timing-function: ease-out;
                animation-delay: 0s;
                animation-iteration-count: 1; 
                animation-direction: normal;
                animation-play-state: running;
                animation-fill-mode: forwards;
            }
            
            .blinking {
                animation-name: glow;
                animation-duration: 125ms;
                animation-timing-function: ease-in-out;
                animation-delay: 0s;
                animation-iteration-count: 8; 
                animation-direction: alternate;
                animation-play-state: running;
                animation-fill-mode: forwards;
            }

            #needle{
                position: absolute;
                top: calc( 50% - 16px );
                right: calc( -32px + calc( 50% - calc( var(--size-x) / 2 ) ) );
                width: 64px;
                height: 32px;
                z-index: 1000;
                background-color: #f00;
                clip-path: polygon(0% 50%, 100% 0%, 100% 100%, 0% 50%);
                box-shadow: 4px 4px 0px #000;
            }

            @keyframes rolling {
                  0% { transform: rotateZ(  0deg); }
                100% { transform: rotateZ(360deg); }
            }
            
            @keyframes glow {
                  0% { filter: brightness(200%); }
                100% { filter: brightness(100%); }
            }
            
            @keyframes stopping {
                  0% {                             }
                 25% { transform: rotateZ(360deg); }
                100% { transform: rotateZ(489deg); }
            }

        </style>
    </head>
    <body>
        <div id="{% name %}">
            <div id="output-shadow" class="">
            </div>
            <div id="output" class="" onclick="{% Name %}.action.handle(this)">
                <div id="slot[0]" class="slice"><span></span></div>
                <div id="slot[1]" class="slice"><span></span></div>
                <div id="slot[2]" class="slice"><span></span></div>
                <div id="slot[3]" class="slice"><span></span></div>
                <div id="slot[4]" class="slice"><span></span></div>
                <div id="slot[5]" class="slice"><span></span></div>
                <div id="slot[6]" class="slice"><span></span></div>
                <div id="slot[7]" class="slice"><span></span></div>
            </div>
            <div id="needle" class=""></div>            
        </div>        
        
        <script>
            {% plugin %}

            var {% Name %} = {
                
                running  : false,
                stopping : false,
                rotation : 0,
                rotation_delta : 0.0,
                rotation_speed : 8.0,
                rotation_delta_change : 0.0,
                status   : 'ready',

                data : {
                    
                },

                dom : {
                    {% name %}      : document.getElementById('{% name %}'),
                    output          : document.getElementById('output'),
                    slot            : [
                        document.getElementById('slot[0]').getElementsByTagName('span')[0],
                        document.getElementById('slot[1]').getElementsByTagName('span')[0],
                        document.getElementById('slot[2]').getElementsByTagName('span')[0],
                        document.getElementById('slot[3]').getElementsByTagName('span')[0],
                        document.getElementById('slot[4]').getElementsByTagName('span')[0],
                        document.getElementById('slot[5]').getElementsByTagName('span')[0],
                        document.getElementById('slot[6]').getElementsByTagName('span')[0],
                        document.getElementById('slot[7]').getElementsByTagName('span')[0],
                    ],
                },

                {% framework %}
                
       
                update : function(){
                    {% Name %}.socket.send(`get-${ {% Name %}.endpoint }`);       
                },

                render : function(){
                    i = 0;
                    for( game in {% Name %}.data.games ){
                        if(i>=8)return;
                        {% Name %}.dom.slot[i].innerHTML = {% Name %}.data.games[game];
                        i++;
                    }
                },

                action : {
                    handle : function(){
                        console.log('->', {% Name %}.status);
                        switch( {% Name %}.status){
                            
                            case 'ready'    : 
                                {% Name %}.action.deselect();
                                {% Name %}.status = 'starting';
                                return {% Name %}.action.handle();
                            
                            case 'starting' : 
                                {% Name %}.rotation_delta_change = 0.5; 
                                setTimeout(function(){
                                    {% Name %}.rotation_delta_change = 0.0;
                                    {% Name %}.status = 'rolling';
                                },2000);
                                break;

                            case 'rolling'  : 
                                {% Name %}.status = 'stoping';
                                return {% Name %}.action.handle();
                                break;

                            case 'stoping'  : 
                                {% Name %}.rotation_delta_change = -0.1;                                 
                                break;
                            
                            case 'stopped'  : 
                                // Reset the roulette
                                {% Name %}.status = 'ready';
                                return {% Name %}.action.handle();
                                break;
                        }
                        console.log({% Name %}.status, '->');
                        return;                        
                    },

                    start : function(){
                        console.log("Starting...");
                        if( {% Name %}.running ) return;
                        {% Name %}.action.deselect();
                        {% Name %}.dom.output.className = '';
                        {% Name %}.dom.output.style.animationPlayState = 'running';
                        {% Name %}.running = true;
                        {% Name %}.dom.output.className = 'starting';
                        setTimeout(function(){
                            console.log("Rolling...");
                            {% Name %}.dom.output.className = 'rolling';
                        }, 2000);
                    },
                    stop : function(){
                        if( {% Name %}.stopping) return;
                        console.log("Stopping...");
                        {% Name %}.running = false;
                        {% Name %}.stopping = true;
                        {% Name %}.dom.output.className = 'stopping';
                        setTimeout(function(){
                            console.log("Stopped...");
                            //{% Name %}.dom.output.style.animationPlayState = 'paused';                        
                            {% Name %}.action.select(parseInt(Math.random()*8));
                            {% Name %}.stopping = false;
                        }, 4000);
                    },
                    select : function( slice ){
                        document.getElementById(`slot[${slice}]`).className = 'slice blinking';
                    },
                    deselect : function(){
                        for(i=0; i<8; i++){
                            document.getElementById(`slot[${i}]`).className = 'slice';
                        }
                    },
                },

                {% websocket %}
                
                socketHandle : function( event ){
                    payload = JSON.parse(event.data);
                    if(payload.response=={% Name %}.endpoint){
                        console.log("WS ({% Name %}) : Got new roulette data : ", payload.data)
                        {% Name %}.data = JSON.parse(payload.data);
                        {% Name %}.render();
                        
                        setTimeout( {% Name %}.update, 5000 );
                    }
                },

                updateRotation : function(){
                    {% Name %}.dom.output.style.transform = `rotateZ(${{% Name %}.rotation}deg)`;
                    if({% Name %}.rotation_delta < 0){
                        {% Name %}.rotation_delta = 0;
                        {% Name %}.rotation_delta_change = 0.0;
                        {% Name %}.status         = 'stopped';
                        {% Name %}.action.select(parseInt(((360-{% Name %}.rotation) / 360)*8));
                                    
                    }  else {
                        {% Name %}.rotation += {% Name %}.rotation_delta;
                        {% Name %}.rotation_delta += {% Name %}.rotation_delta_change;
                        if({% Name %}.rotation_delta > {% Name %}.rotation_speed){% Name %}.rotation_delta = {% Name %}.rotation_speed;
                        if({% Name %}.rotation_delta < -{% Name %}.rotation_speed){% Name %}.rotation_delta = -{% Name %}.rotation_speed;
                        {% Name %}.rotation %= 360;
                    }
                },
                
                start : function(){
                    {% Name %}.loadSettings();
                    {% Name %}.messageHandler();
                    {% Name %}.connect();
                    /*{% Name %}.action.start();*/
                    setInterval({% Name %}.updateRotation, 16);
                }
            }
            // Dont forget to start the plugin after defining its class!
            {% Name %}.start()
        </script>
        {% monitor %}
    </body>
</html>